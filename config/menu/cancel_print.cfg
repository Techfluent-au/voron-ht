[menu __main __cancel_print]
type: command
enable: {printer.idle_timeout.state == "Printing"}
name: Cancel print
index: 1
gcode: |
    {% set Z_LIFT = 20 %}

    {% set WAS_HOMED = ('z' in printer.toolhead.homed_axes) %}
    {% set CURRENT_Z = printer.gcode_move.gcode_position.z %}
    {% if WAS_HOMED and (Z_LIFT|float > 0)%}
        {% set Z_LEFT = (printer.toolhead.axis_maximum.z) - CURRENT_Z %}
        {% set MAX_LIFT = (Z_LIFT|float, Z_LEFT|float)|min %}
        {% if (MAX_LIFT|float) > 0 %}
            G91
            G1 Z{MAX_LIFT} F3000
        {% endif %}
    {% endif %}
    {action_respond_info('action:cancel')}


